.PHONY: build run test clean docker-build docker-run k8s-deploy k8s-delete

# Goç›¸å…³å˜é‡
BINARY_NAME=whatsapp-aggregator
MAIN_PATH=./cmd/server
BUILD_DIR=./build

# Dockerç›¸å…³å˜é‡
DOCKER_IMAGE=whatsapp-aggregator:latest
DOCKER_COMPOSE_FILE=./deployments/docker/docker-compose.yml

# K8sç›¸å…³å˜é‡
K8S_NAMESPACE=whatsapp
K8S_MANIFESTS=./deployments/k8s

# æ„å»ºåº”ç”¨
build:
	@echo "ğŸ”¨ æ„å»ºåº”ç”¨..."
	@mkdir -p $(BUILD_DIR)
	@CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o $(BUILD_DIR)/$(BINARY_NAME) $(MAIN_PATH)
	@echo "âœ… æ„å»ºå®Œæˆ: $(BUILD_DIR)/$(BINARY_NAME)"

# è¿è¡Œåº”ç”¨
run:
	@echo "ğŸš€ å¯åŠ¨åº”ç”¨..."
	@go run $(MAIN_PATH)

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@go test -v ./...

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf $(BUILD_DIR)
	@go clean

# å®‰è£…ä¾èµ–
deps:
	@echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
	@go mod tidy
	@go mod download

# æ„å»ºDockeré•œåƒ
docker-build:
	@echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
	@docker build -t $(DOCKER_IMAGE) .
	@echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ: $(DOCKER_IMAGE)"

# ä½¿ç”¨Docker Composeè¿è¡Œ
docker-run:
	@echo "ğŸ³ ä½¿ç”¨Docker Composeå¯åŠ¨æœåŠ¡..."
	@cd deployments/docker && docker-compose up -d
	@echo "âœ… æœåŠ¡å·²å¯åŠ¨ï¼Œè®¿é—®: http://localhost:8080"

# åœæ­¢Docker ComposeæœåŠ¡
docker-stop:
	@echo "ğŸ›‘ åœæ­¢Docker ComposeæœåŠ¡..."
	@cd deployments/docker && docker-compose down
	@echo "âœ… æœåŠ¡å·²åœæ­¢"

# æŸ¥çœ‹Docker Composeæ—¥å¿—
docker-logs:
	@cd deployments/docker && docker-compose logs -f

# æ„å»ºWhatsApp NodeæœåŠ¡é•œåƒ
build-node-service:
	@echo "ğŸ”¨ æ„å»ºWhatsApp NodeæœåŠ¡é•œåƒ..."
	@cd ../whatsapp-node-service && docker build -t whatsapp-node-service:latest .
	@echo "âœ… WhatsApp NodeæœåŠ¡é•œåƒæ„å»ºå®Œæˆ"

# å®Œæ•´Dockeréƒ¨ç½²
docker-deploy: build-node-service docker-build docker-run

# K8séƒ¨ç½²
k8s-deploy:
	@echo "â˜¸ï¸ éƒ¨ç½²åˆ°Kubernetes..."
	@kubectl apply -f $(K8S_MANIFESTS)/namespace.yaml
	@kubectl apply -f $(K8S_MANIFESTS)/aggregator-deployment.yaml
	@echo "âœ… K8séƒ¨ç½²å®Œæˆ"
	@echo "ğŸ“‹ æŸ¥çœ‹çŠ¶æ€: kubectl get pods -n $(K8S_NAMESPACE)"

# K8såˆ é™¤
k8s-delete:
	@echo "ğŸ—‘ï¸ ä»Kubernetesåˆ é™¤..."
	@kubectl delete -f $(K8S_MANIFESTS)/aggregator-deployment.yaml --ignore-not-found=true
	@kubectl delete -f $(K8S_MANIFESTS)/namespace.yaml --ignore-not-found=true
	@echo "âœ… K8sèµ„æºå·²åˆ é™¤"

# K8sçŠ¶æ€æŸ¥çœ‹
k8s-status:
	@echo "ğŸ“‹ æŸ¥çœ‹K8sçŠ¶æ€..."
	@kubectl get all -n $(K8S_NAMESPACE)

# K8sæ—¥å¿—æŸ¥çœ‹
k8s-logs:
	@echo "ğŸ“ æŸ¥çœ‹K8sæ—¥å¿—..."
	@kubectl logs -f deployment/whatsapp-aggregator -n $(K8S_NAMESPACE)

# å¼€å‘ç¯å¢ƒè®¾ç½®
dev-setup:
	@echo "ğŸ› ï¸ è®¾ç½®å¼€å‘ç¯å¢ƒ..."
	@go mod tidy
	@go install github.com/air-verse/air@latest
	@echo "âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ"
	@echo "ğŸ’¡ ä½¿ç”¨ 'air' å‘½ä»¤å¯åŠ¨çƒ­é‡è½½å¼€å‘æœåŠ¡å™¨"

# çƒ­é‡è½½å¼€å‘
dev:
	@echo "ğŸ”¥ å¯åŠ¨çƒ­é‡è½½å¼€å‘æœåŠ¡å™¨..."
	@air

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	@go fmt ./...

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	@golangci-lint run

# ç”ŸæˆAPIæ–‡æ¡£
docs:
	@echo "ğŸ“š ç”ŸæˆAPIæ–‡æ¡£..."
	@swag init -g $(MAIN_PATH)/main.go

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "WhatsApp Multi-Service Aggregator"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  build              æ„å»ºåº”ç”¨"
	@echo "  run                è¿è¡Œåº”ç”¨"
	@echo "  test               è¿è¡Œæµ‹è¯•"
	@echo "  clean              æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  deps               å®‰è£…ä¾èµ–"
	@echo ""
	@echo "Dockerå‘½ä»¤:"
	@echo "  docker-build       æ„å»ºDockeré•œåƒ"
	@echo "  docker-run         ä½¿ç”¨Docker Composeè¿è¡Œ"
	@echo "  docker-stop        åœæ­¢Docker ComposeæœåŠ¡"
	@echo "  docker-logs        æŸ¥çœ‹Dockeræ—¥å¿—"
	@echo "  docker-deploy      å®Œæ•´Dockeréƒ¨ç½²"
	@echo ""
	@echo "K8så‘½ä»¤:"
	@echo "  k8s-deploy         éƒ¨ç½²åˆ°Kubernetes"
	@echo "  k8s-delete         ä»Kubernetesåˆ é™¤"
	@echo "  k8s-status         æŸ¥çœ‹K8sçŠ¶æ€"
	@echo "  k8s-logs           æŸ¥çœ‹K8sæ—¥å¿—"
	@echo ""
	@echo "å¼€å‘å‘½ä»¤:"
	@echo "  dev-setup          è®¾ç½®å¼€å‘ç¯å¢ƒ"
	@echo "  dev                å¯åŠ¨çƒ­é‡è½½å¼€å‘æœåŠ¡å™¨"
	@echo "  fmt                æ ¼å¼åŒ–ä»£ç "
	@echo "  lint               ä»£ç æ£€æŸ¥"
	@echo "  docs               ç”ŸæˆAPIæ–‡æ¡£"
