version: '3.8'

services:
  whatsapp-aggregator:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: whatsapp-aggregator
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - SERVER_HOST=0.0.0.0
      - ENVIRONMENT=production
      - DOCKER_ENABLED=true
      - K8S_ENABLED=false
      - WHATSAPP_IMAGE=whatsapp-node-service:latest
      - DOCKER_NETWORK=whatsapp-network
      - DOCKER_BASE_PORT=3000
      - DB_TYPE=sqlite
      - DB_NAME=/data/whatsapp_aggregator.db
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - whatsapp_data:/data
    networks:
      - whatsapp-network
    restart: unless-stopped
    depends_on:
      - whatsapp-node-service

  whatsapp-node-service:
    build:
      context: ../../whatsapp-node-service
      dockerfile: Dockerfile
    image: whatsapp-node-service:latest
    # 这个服务不会直接运行，只是用来构建镜像
    command: ["echo", "Image built successfully"]
    networks:
      - whatsapp-network

networks:
  whatsapp-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  whatsapp_data:
    driver: local
